<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 3. How to make OSGi easy peasy</title><link rel="stylesheet" href="css/seamframework.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><link rel="home" href="index.html" title="CDI OSGi integration"/><link rel="up" href="index.html" title="CDI OSGi integration"/><link rel="prev" href="ch02.html" title="Chapter 2. Organization of CDI-OSGi"/><link rel="next" href="ch04.html" title="Chapter 4. Weld-OSGi implementation"/></head><body><p id="title"><a href="http://www.seamframework.org" class="site_href"><strong>SeamFramework.org</strong></a><a href="http://www.seamframework.org/Documentation" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ch02.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ch04.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e338"/>Chapter 3. How to make OSGi easy peasy</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch03.html#d0e341">3.1. Injecting easiness in OSGi world</a></span></dt><dt><span class="section"><a href="ch03.html#d0e357">3.2. CDI usage in bean bundles</a></span></dt><dt><span class="section"><a href="ch03.html#d0e364">3.3. Service bean and auto-published OSGi service</a></span></dt><dt><span class="section"><a href="ch03.html#d0e409">3.4. OSGi service auto-publication with Publish annotation </a></span></dt><dd><dl><dt><span class="section"><a href="ch03.html#d0e426">3.4.1. Service type resolution</a></span></dt><dt><span class="section"><a href="ch03.html#d0e453">3.4.2. Service type blacklist</a></span></dt></dl></dd><dt><span class="section"><a href="ch03.html#d0e458">3.5. OSGiService annotated or Service&lt;T&gt; typed injection
            points</a></span></dt><dt><span class="section"><a href="ch03.html#d0e529">3.6. OSGiServiceBean and OSGiServiceProviderBean</a></span></dt><dt><span class="section"><a href="ch03.html#d0e553">3.7. Clearly specify a service implementation</a></span></dt><dd><dl><dt><span class="section"><a href="ch03.html#d0e562">3.7.1. Link between qualifiers and OSGi LDAP properties</a></span></dt><dt><span class="section"><a href="ch03.html#d0e629">3.7.2. Special qualifiers</a></span></dt><dt><span class="section"><a href="ch03.html#d0e660">3.7.3. Final LDAP filter</a></span></dt><dt><span class="section"><a href="ch03.html#d0e730">3.7.4. Using service filtering</a></span></dt></dl></dd><dt><span class="section"><a href="ch03.html#d0e776">3.8. Bean disambiguation and annotated type processing</a></span></dt><dd><dl><dt><span class="section"><a href="ch03.html#d0e865">3.8.1. Examples</a></span></dt><dt><span class="section"><a href="ch03.html#d0e935">3.8.2. Justification</a></span></dt></dl></dd><dt><span class="section"><a href="ch03.html#d0e946">3.9. Contextual services</a></span></dt><dd><dl><dt><span class="section"><a href="ch03.html#d0e972">3.9.1. OSGi service scopes</a></span></dt></dl></dd><dt><span class="section"><a href="ch03.html#d0e1019">3.10. Required services</a></span></dt><dt><span class="section"><a href="ch03.html#d0e1045">3.11. Inaccessible service at runtime</a></span></dt><dt><span class="section"><a href="ch03.html#d0e1069">3.12. OSGi facilitation</a></span></dt><dd><dl><dt><span class="section"><a href="ch03.html#d0e1072">3.12.1. Service registry</a></span></dt><dt><span class="section"><a href="ch03.html#d0e1100">3.12.2. OSGi utilities</a></span></dt><dt><span class="section"><a href="ch03.html#d0e1159">3.12.3. The registration</a></span></dt></dl></dd><dt><span class="section"><a href="ch03.html#d0e1196">3.13. CDI-OSGi events</a></span></dt><dd><dl><dt><span class="section"><a href="ch03.html#d0e1219">3.13.1. CDI container lifecycle events</a></span></dt><dt><span class="section"><a href="ch03.html#d0e1237">3.13.2. Bundle lifecycle events</a></span></dt><dt><span class="section"><a href="ch03.html#d0e1297">3.13.3. Service lifecyle events</a></span></dt><dt><span class="section"><a href="ch03.html#d0e1328">3.13.4. Bean bundle required service dependency validation events</a></span></dt><dt><span class="section"><a href="ch03.html#d0e1346">3.13.5. Intra and inter bundles communication events</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e341"/>3.1. Injecting easiness in OSGi world</h2></div></div></div><p>CDI-OSGi provides more functionality using CDI in a OSGi environment.</p><p>It mainly focuses on the OSGi service layer. It addresses the difficulties in
            publishing and consuming services. CDI-OSGi allows developers to: </p><div class="itemizedlist"><ul><li><p>Automatically publish CDI beans as OSGi services</p></li><li><p>Consume OSGi services as CDI beans</p></li></ul></div><p>CDI-OSGi also provides utilities for event notification and communication in and
            between bundles as well as some general OSGi utilities. CDI-OSGi brings a complete
            support of CDI into bean bundles too.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e357"/>3.2. CDI usage in bean bundles</h2></div></div></div><p>Everything possible in CDI application is possible in bean bundle. They can take
            advantage of injection, producers, interceptors, decorators and alternative. But
            influence boundary of the CDI compliant container stay within the bean bundle for
            classic CDI usages. So external dependencies cannot be injected and interceptor,
            decorator or alternative of another bean bundle cannot be used (yet interceptors,
            decorators and alternatives still need to be declares in the bean bundle bean.xml file). </p><p>That is all we will say about classic CDI usages, please report to CDI documentation
            for more information.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e364"/>3.3. Service bean and auto-published OSGi service</h2></div></div></div><p>A CDI-OSGi auto-published service is described by these attributes (and their
            equivalents for a regular OSGi service): </p><div class="itemizedlist"><ul><li><p>A (nonempty) set of service contracts (service class names)</p></li><li><p>A set of qualifiers (service properties)</p></li><li><p>A scope</p></li><li><p>A <code class="code">Publish</code> annotated CDI bean instance (service
                        instance)</p></li></ul></div><p>A CDI-OSGi service bean  is described by these attributes (and their equivalents for
            OSGi service lookup): </p><div class="itemizedlist"><ul><li><p>An <code class="code">OSGiService</code> annotated or <code class="code">Service&lt;T&gt;</code> typed
                        injection point</p></li><li><p>A type (lookup type)</p></li><li><p>A <code class="code">Filter</code> qualifier (lookup LDAP filter)</p></li><li><p>A (possibly empty) set of reachable instance (lookup result)</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e409"/>3.4. OSGi service auto-publication with <code class="code">Publish</code> annotation </h2></div></div></div><p>Annotate a CDI bean class with a <code class="code">Publish</code> annotation makes CDI-OSGi
            register this bean as a OSGi service. Then the service is accessible through CDI-OSGi
            service injection and OSGi classic mechanisms.</p><p>Automatically publish a new service implementation:
            </p><pre class="programlisting">@Publish
public class MyServiceImpl implements MyService {
}</pre><p>However, such an implementation also provides a regular CDI managed bean, so
            MyServiceImpl can also be injected using CDI within the bean bundle.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e426"/>3.4.1. Service type resolution</h3></div></div></div><p>CDI-OSGi auto-published service get their types from the following algorithm:</p><div class="itemizedlist"><ul><li><p>If a (nonempty) contract list is provided (as an array of
                                <code class="code">Class</code>) with the <code class="code">Publish</code> annotation the
                            service is registered for all these types. This is how define a contract
                            list:</p><pre class="programlisting">@Publish(contracts = {
        MyService.class,
        AbstractClass.class
})
public class MyServiceImpl extends AbstractClass implements MyService, OtherInterface {
}</pre><p>The
                            implementation class may be assignable for all of the contract types. If
                            not, CDI-OSGi detects the problem and treats it as an error.</p></li><li><p>Else if the implementation class possesses a (nonempty) list of
                            non-blacklisted interfaces the service is registered for all these
                            interface types.The blacklist is described below.</p></li><li><p>Else if CDI-OSGi the implementation class possesses a non-blacklisted
                            superclass the service is registered for this superclass type.</p></li><li><p>Last if the implementation class has neither contract nor
                            non-blacklisted interface or superclass, the service is register with is
                            the implementation class type.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e453"/>3.4.2. Service type blacklist</h3></div></div></div><p>An CDI implementation bundle might provide a type blacklist in order to filter
                auto-published OSGi service allowed type. Please refer to the CDI implementation
                bundle documentation to see if such a blacklist is enable and how to configure
                it.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e458"/>3.5. <code class="code">OSGiService</code> annotated or <code class="code">Service&lt;T&gt;</code> typed injection
            points</h2></div></div></div><p>A <code class="code">OSGiService</code> annotated or a <code class="code">Service&lt;T&gt;</code> typed injection
            point is managed by CDI-OSGi through the creation of a new service
                bean.<code class="code">OSGiService</code> annotation and <code class="code">Service&lt;T&gt;</code> type are
            exclusive on injection point. If an injection point has both, CDI-OSGi detects the
            problem and treats it as an error.</p><div class="itemizedlist"><ul><li><p>Direct injection with <code class="code">OSGiService</code> annotation and
                        <code class="code">OSGiServiceBean</code>:
                    </p><pre class="programlisting">@Inject @OSGiService MyService service;</pre><p>Such an
                    injection point (an OSGi service injection point) will match an unique CDI-OSGi
                        <code class="code">OSGiServiceBean</code>.</p><p>For every different OSGi service injection point an unique
                        <code class="code">OSGiServiceBean</code> is generated by CDI-OSGi.</p></li><li><p>Injection using programmatic lookup with <code class="code">Service&lt;T&gt;</code> type and
                        <code class="code">OSGiServiceProviderBean</code>:
                    </p><pre class="programlisting">@Inject Service&lt;MyService&gt; services;</pre><p>Such an
                    injection point (an OSGi service provider injection point) will match an unique
                    CDI-OSGi <code class="code">OSGiServiceProviderBean</code>.</p><p>For every different OSGi service provider injection point an unique
                        <code class="code">OSGiServiceProviderBean</code> is generated by CDI-OSGi.</p></li></ul></div><p>
            <code class="code">OSGiService</code> annotated or a <code class="code">Service&lt;T&gt;</code> typed injection
            points are not eligible to regular CDI injection.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e529"/>3.6. <code class="code">OSGiServiceBean</code> and <code class="code">OSGiServiceProviderBean</code></h2></div></div></div><p><code class="code">OSGiServiceBean</code> injects an instance of the first service implementation
            matching the injection point.</p><p><code class="code">OSGiServiceProviderBean</code> injects a service provider (as a
                <code class="code">Service&lt;T&gt;</code>) for all the service implementations matching the
            injection point.</p><p>Service provider allows to over-specify the matching service implementation set with
            additional OSGi service properties.</p><p>Service provider does not allow to subtype the matching service implementation
            set.</p><p>Service provider allows to instantiate the first service implementation matching the
            (possibly) over-specified injection point.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e553"/>3.7. Clearly specify a service implementation</h2></div></div></div><p><code class="code">Qualifier</code> annotated annotations might be use for both specifying
            auto-published services and service injection points. Such qualifiers should be seen as
            OSGi service properties, thus every set of qualifiers corresponds to a set of OSGi
            service properties and so to a OSGi service LDAP filter.</p><p>However qualifiers keep a regular meaning for the CDI generated bean of an
            auto-published service class.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e562"/>3.7.1. Link between qualifiers and OSGi LDAP properties</h3></div></div></div><p>A qualifier will generate an OSGi service property for each of its valued element
                (an element with a default value is always considered valued) following these rules:</p><div class="itemizedlist"><ul><li><p>A valued element generate a property with this
                            template:</p><pre class="programlisting"><span class="italic">decapitalized_qualifier_name</span>.<span class="italic">decapitalized_element_name</span>=<span class="italic">element_value.toString()</span></pre><pre class="programlisting">@MyQualifier(lang="EN", country="US")</pre><p>will
                            generate:</p><pre class="programlisting">(myqualifier.lang=EN)
(myqualifier.country=US)</pre></li><li><p>A non valued element with a default value generate a property with
                            this
                            template:</p><pre class="programlisting"><span class="italic">decapitalized_qualifier_name</span>.<span class="italic">decapitalized_element_name</span>=<span class="italic">element_default_value.toString()</span></pre><pre class="programlisting">@MyQualifier(lang="EN")</pre><p>will
                            generate:</p><pre class="programlisting">(myqualifier.lang=EN)
(myqualifier.country=US) //admitting US is the default value for the element country</pre></li><li><p>A non valued element with no default value generate a property with
                            this
                            template:</p><pre class="programlisting"><span class="italic">decapitalized_qualifier_name</span>.<span class="italic">decapitalized_element_name</span>=*</pre><pre class="programlisting">@MyQualifier(lang="EN")</pre><p>will
                            generate:</p><pre class="programlisting">(myqualifier.lang=EN)
(myqualifier.country=*) //admitting there is no default value for the element country</pre></li><li><p>A qualifier with no element generate a property with this
                            template:</p><pre class="programlisting"><span class="italic">decapitalized_qualifier_name</span>=*</pre><pre class="programlisting">@MyQualifier()</pre><p>will
                            generate:</p><pre class="programlisting">(myqualifier=*)</pre></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e629"/>3.7.2. Special qualifiers</h3></div></div></div><div class="itemizedlist"><ul><li><p><code class="code">OSGiService</code> qualifier will not generate any service
                        property</p></li><li><p><code class="code">Required</code> qualifier will not generate any service
                        property</p></li><li><p><code class="code">Filter</code> qualifier undergoes a special processing: </p><div class="itemizedlist"><ul><li><p>Its value element value is reused as it is as a supposedly
                                    valid OSGi service LDAP filter</p></li><li><p>Its each of the string of its properties element (an array of
                                    string)  is reused as it is as a supposedly valid OSGi service
                                    property</p></li></ul></div></li></ul></div><p>It is discourage to use the <code class="code">Filter</code> qualifier on a bean that might be
                use as a regular CDI bean.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e660"/>3.7.3. Final LDAP filter</h3></div></div></div><p>CDI-OSGi processes all the OSGi LDAP properties and provided OSGi LDAP filter to
                generate a global OSGi LDAP filter as:</p><div class="itemizedlist"><ul><li><p>With multiple OSGi LDAP properties and a provided OSGi LDAP
                            filter</p><pre class="programlisting">(&amp; <span class="italic">provided_ldap_filter</span> (<span class="italic">ldap_property_1</span>) (<span class="italic">ldap_property_2</span>) ... (<span class="italic">ldap_property_i</span>) )</pre></li><li><p>With multiple OSGi LDAP properties and no provided OSGi LDAP
                            filter</p><pre class="programlisting">(&amp; (<span class="italic">ldap_property_1</span>) (<span class="italic">ldap_property_2</span>) ... (<span class="italic">ldap_property_i</span>) )</pre></li><li><p>With one OSGi LDAP properties and a provided OSGi LDAP
                            filter</p><pre class="programlisting">(&amp; <span class="italic">provided_ldap_filter</span> (<span class="italic">ldap_property</span>) )</pre></li><li><p>With one OSGi LDAP properties and no provided OSGi LDAP
                            filter</p><pre class="programlisting">(<span class="italic">ldap_property</span>)</pre></li><li><p>With no OSGi LDAP properties and a provided OSGi LDAP
                            filter</p><pre class="programlisting"><span class="italic">provided_ldap_filter</span></pre></li><li><p>With no OSGi LDAP properties and no provided OSGi LDAP
                            filter</p><pre class="programlisting"><span class="italic">null</span></pre></li></ul></div><p>CDI-OSGi never ensure that, neither the provided OSGi LDAP properties, neither the
                provided OSGi LDAP filter, neither the generated OSGi LDAP filter, are valid.
            </p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e730"/>3.7.4. Using service filtering</h3></div></div></div><div class="itemizedlist"><ul><li><p>On an auto-published service class:
                        </p><pre class="programlisting">@Publish
@AnyQualifier
public class MyServiceQualifiedImpl implements MyService {
}</pre><p>Will
                        generate an <code class="code">AnyQualifier</code> qualified regular CDI bean and
                        register an OSGi service with the property (anyqualifier=*).</p></li><li><p>On an OSGi service injection point:
                        </p><pre class="programlisting">@Inject @OSGiService @AnyQualifier MyService qualifiedService;
@Inject @AnyQualifier Service&lt;MyService&gt; qualifiedServices;</pre><p>Will
                        generate an <code class="code">OSGiServiceBean</code> and an
                            <code class="code">OSGiServiceProducerBean</code> looking up for OSGi services with
                        the  property (anyqualifier=*).</p></li><li><p>With an
                        <code class="code">OSGiServiceProducerBean</code>:</p><pre class="programlisting">services.select(new AnnotationLiteral&lt;AnyQualifier&gt;() {}).get().deSomething();</pre><p>Will
                        over-specify the valid service implementation set to those matching the
                        property (anyqualifier=*).</p></li><li><p>Using the special <code class="code">Filter</code>
                        qualifier:</p><pre class="programlisting">@Publish
@Filter(value="(lang=EN)",
        properties = {"country=US",
                      "currency=*")
        })
public class MyServiceQualifiedImpl implements MyService {
}</pre><p>Will
                        generate an <code class="code">Filter(...)</code> qualified regular CDI bean and register
                        an OSGi service with the properties (lang=EN) [as a complete OSGi service
                        LDAP filter], (country=US) and (currency=*). </p></li></ul></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e776"/>3.8. Bean disambiguation and annotated type processing</h2></div></div></div><p>CDI-OSGi ensures that every <code class="code">OSGiService</code> annotated or
                <code class="code">Serive&lt;T&gt;</code> typed injection point matches an unique
                <code class="code">OSGiServiceBean</code> or <code class="code">OSGiServiceProviderBean</code>.</p><p>Therefore, for every bean bundle CDI-OSGi:</p><div class="itemizedlist"><ul><li><p>Processes annotated types</p></li><li><p>Wraps every  <code class="code">OSGiService</code> annotated or
                            <code class="code">Service&lt;T&gt;</code> typed injection point</p></li></ul></div><p><code class="code">OSGiService</code> annotated injection points are wrapped
            as:</p><pre class="programlisting">@Inject @OSGiService @Filter(<span class="italic">Calculated_filter</span>) <span class="italic">Type</span> <span class="italic">var_name</span>;</pre><p><code class="code">Service&lt;T&gt;</code> typed injection points are wrapped
            as:</p><pre class="programlisting">@Inject @Filter(<span class="italic">Calculated_filter</span>) Service&lt;<span class="italic">Type</span>&gt; <span class="italic">var_name</span>;</pre><p>The global OSGi LDAP filter of the final <code class="code">Filter</code> qualifier is calculated from:</p><div class="itemizedlist"><ul><li><p>The original set of qualifiers (except <code class="code">OSGiService</code> and
                            <code class="code">Filter</code>)</p></li><li><p>The OSGi LDAP filter value of the original <code class="code">Filter</code>
                        qualifier</p></li><li><p>The set of properties of the original <code class="code">Filter</code>
                        annotation</p></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e865"/>3.8.1. Examples</h3></div></div></div><div class="itemizedlist"><ul><li><pre class="programlisting">@Inject @OSGiService MyService qualifiedService;</pre><p>will
                        become:</p><pre class="programlisting">@Inject @OSGiService <span class="bold"><strong>@Filter("")</strong></span> MyService qualifiedService;</pre></li><li><pre class="programlisting">@Inject @OSGiService <span class="bold"><strong>@AnyQualifier</strong></span> MyService qualifiedService;</pre><p>will
                        become:</p><pre class="programlisting">@Inject @OSGiService <span class="bold"><strong>@Filter("(anyqualifier=*)")</strong></span> MyService qualifiedService;</pre></li><li><pre class="programlisting">@Inject <span class="bold"><strong>@AnyQualifier</strong></span> Service&lt;MyService&gt; qualifiedServices;</pre><p>will
                        become:</p><pre class="programlisting">@Inject <span class="bold"><strong>@Filter("(anyqualifier=*)")</strong></span> Service&lt;MyService&gt; qualifiedService;</pre></li><li><pre class="programlisting">@Inject <span class="bold"><strong>@OSGiService</strong></span> @AnyQualifier <span class="bold"><strong>Service&lt;</strong></span>MyService<span class="bold"><strong>&gt;</strong></span> qualifiedServices;</pre><p>will
                        generate an error.</p></li><li><pre class="programlisting">@Inject @OSGiService <span class="bold"><strong>@AnyQualifier</strong></span> <span class="bold"><strong>@Filter(value="(lang=EN)",properties={"country=US","currency=*"})</strong></span> MyService qualifiedService;</pre><p>will
                        become:</p><pre class="programlisting">@Inject @OSGiService <span class="bold"><strong>@Filter("(&amp;(anyqualifier=*)(lang=EN)(country=US)(currency=*))</strong></span> MyService qualifiedService;</pre></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e935"/>3.8.2. Justification</h3></div></div></div><div class="figure"><a id="d0e938"/><div class="figure-contents"><div class="mediaobject"><img src="file:/Users/mathieuancelin/Desktop/weld/weld-osgi/cdi-osgi-documentation/cdi-osgi-design/target/docbook/staging/images/../../../../../../../../../../T%C3%A9l%C3%A9chargements/CDI-OSGipublishconsumecycle.png" alt="Annotated type processing justification"/><div class="caption">This figure show the need for a annotated type processing in order to
                        remove the ambiguous dependency between regular CDI and CDI-OSGi injection
                        points.</div></div></div><p class="title"><b>Figure 3.1. Annotated type processing justification</b></p></div><br class="figure-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e946"/>3.9. Contextual services</h2></div></div></div><p>An auto-published service instance is a CDI contextual instance, so:</p><div class="itemizedlist"><ul><li><p>The instance injected through a <code class="code">OSGiService</code> annotated or
                            <code class="code">Service&lt;T&gt;</code> typed injection point might be a CDI
                        contextual instance</p></li><li><p>The instance obtained through a regular OSGi service checkout might be a
                        CDI contextual instance</p></li><li><p>In either cases CDI-OSGi ensures that the injected or obtained instance is
                        contextual if <span class="bold"><strong>no</strong></span> similar service is
                        published using regular OSGi mechanism</p></li></ul></div><p>It is discourage to use regular OSGi service publication mechanisms in a CDI-OSGi
            application.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e972"/>3.9.1. OSGi service scopes</h3></div></div></div><p>A CDI scope might be precised for every auto-published service class:</p><div class="itemizedlist"><ul><li><p>If no scope is provided <code class="code">Dependent</code> is assumed, granting a
                            capacity similar to regular OSGi service</p></li><li><p>Only one scope may be precised for every auto-published service
                            class</p></li><li><p>The scope is shared by both generated regular CDI bean and OSGi
                            service</p></li><li><p>The available scopes are: <code class="code">Dependent</code>,
                                <code class="code">Singleton</code>, <code class="code">ApplicationScoped</code>,
                                <code class="code">SessionScoped</code>, <code class="code">ConversationScoped</code> and
                                <code class="code">RequestScoped</code>
                        </p></li><li><p>Other scope or pseudo-scope may not be supported by CDI-OSGi</p></li></ul></div><p>
                </p><pre class="programlisting">@Publish
@ApplicationScoped
public class MyServiceImpl implements MyService {
    @Override
    public void doSomething() {
    }
}</pre><p>
            </p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1019"/>3.10. Required services</h2></div></div></div><p>A <code class="code">OSGiService</code> annotated or <code class="code">Serive&lt;T&gt;</code> typed injection
            point might be annotated <code class="code">Required</code></p><div class="itemizedlist"><ul><li><p>with no influence on this injection point</p></li><li><p>with influence on the <code class="code">Valid</code> and <code class="code">Invalid</code> events
                        management in the current bean bundle</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1045"/>3.11. Inaccessible service at runtime</h2></div></div></div><p><code class="code">OSGiServiceBean</code> and <code class="code">OSGiServiceProviderBeans</code> bean instances
            are dynamically obtained OSGi service instance.</p><p>No instance might be available at runtime due to OSGi dynamism, in such case a
                <code class="code">OSGiServiceUnavailableException</code> is thrown with any
                <code class="code">OSGiServiceBean</code> method call or the
                <code class="code">OSGiServiceProviderBeans</code>
            <code class="code">get</code> method call.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1069"/>3.12. OSGi facilitation</h2></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1072"/>3.12.1. Service registry</h3></div></div></div><p>CDI-OSGi allows bean bundles to directly interact with the OSGi service registry
                by getting a <code class="code">ServiceRegistry</code>
                bean:</p><pre class="programlisting">@Inject ServiceRegistry registry;</pre><p>This bean is
                injectable everywhere into a bean bundle.</p><p>It allows to:</p><div class="itemizedlist"><ul><li><p>Register a service implementation</p></li><li><p>Obtain a service provider as a <code class="code">Service&lt;T&gt;</code></p></li><li><p>Obtain all existing registrations</p></li><li><p>Obtain a specific set of registrations </p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1100"/>3.12.2. OSGi utilities</h3></div></div></div><p>CDI-OSGi allows to obtain, by injection into bean bundles, some of the useful
                objects of the OSGi environment:</p><div class="itemizedlist"><ul><li><p>The current
                            bundle</p><pre class="programlisting">@Inject Bundle bundle;</pre></li><li><p>The current bundle
                            context</p><pre class="programlisting">@Inject BundleContext bundleContext;</pre></li><li><p>The current bundle
                            headers</p><pre class="programlisting">@Inject @BundleHeaders Map&lt;String,String&gt;metadata;</pre></li><li><p>A specific current bundle
                            header</p><pre class="programlisting">@Inject @BundleHeader("Bundle-SymbolicName") String symbolicName;</pre></li><li><p>A specific current bundle resource
                            file</p><pre class="programlisting">@Inject @BundleDataFile("test.txt") File file;</pre></li><li><p>The same object of a specified bundle by symbolic name and (optional)
                            version</p><pre class="programlisting">@Inject @BundleName("com.sample.gui") @BundleVersion("4.2.1") bundle;
@Inject @BundleName("com.sample.gui") bundle;</pre><pre class="programlisting">@Inject @BundleName("com.sample.gui") @BundleVersion("4.2.1") @BundleHeaders Map&lt;String,String&gt;metadata;</pre><pre class="programlisting">@Inject @BundleName("com.sample.gui") @BundleVersion("4.2.1") @BundleHeader("Bundle-SymbolicName") String symbolicName;</pre></li></ul></div><p>It is possible to precise an external bundle by bundle symbolic name and
                (optional)
                version</p><pre class="programlisting">@Inject @BundleName("com.sample.gui") @BundleVersion("4.2.1") bundle;
@Inject @BundleName("com.sample.gui") bundle;</pre><pre class="programlisting">@Inject @BundleName("com.sample.gui") @BundleVersion("4.2.1") BundleContext bundleContext;</pre><pre class="programlisting">@Inject @BundleName("com.sample.gui") @BundleVersion("4.2.1") @BundleHeaders Map&lt;String,String&gt;metadata;</pre><pre class="programlisting">@Inject @BundleName("com.sample.gui") @BundleVersion("4.2.1") @BundleHeader("Bundle-SymbolicName") String symbolicName;</pre><pre class="programlisting">@Inject @BundleName("com.sample.gui") @BundleVersion("4.2.1") @BundleDataFile("test.txt") File file;</pre><p>If
                a <code class="code">BundleVersion</code> annotation is provided without a
                    <code class="code">BundleName</code> annotation CDI-OSGi detects the problem and treats it as
                an error.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1159"/>3.12.3. The registration</h3></div></div></div><p>CDI-OSGi allows to obtain, by injection into bean bundles,
                    <code class="code">Registration&lt;T&gt;</code> of a specific type. A registration object
                represent all the bindings between a service contract class and its OSGi
                    <code class="code">ServiceRegistration</code>.</p><pre class="programlisting">@Inject Registration&lt;MyService&gt; registrations;</pre><p>It
                is possible to filter the obtained bindings by specifying OSGi LDAP properties and
                filter.</p><pre class="programlisting">@Inject @AnyQualifier Registration&lt;MyService&gt; qualifiedRegistrations;
@Inject @Filter("(&amp;(lang=EN)(country=US))") Registration&lt;MyService&gt; qualifiedRegistrations;</pre><p>A <code class="code">Registration&lt;T&gt;</code> allows to:</p><div class="itemizedlist"><ul><li><p>Iterate over the contained bindings</p></li><li><p>Select a subset of the bindings using OSGi LDAP properties and
                            filter</p></li><li><p>Obtain a service provider, as a <code class="code">Service&lt;T&gt;</code> for the
                            current bindings</p></li><li><p>Unregister all the services for the current bindings</p></li></ul></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1196"/>3.13. CDI-OSGi events</h2></div></div></div><p>CDI-OSGi provides numerous events about OSGi events and bean bundle lifecycle events.
            It also allows decoupled bean bundle communication.</p><p>All these features uses CDI events mechanisms:</p><div class="itemizedlist"><ul><li><p>These events may be listened with a <code class="code">Observes</code> annotated
                        parameter
                        method</p><pre class="programlisting">public void bindBundle(@Observes AbstractBundleEvent event) {
}</pre></li><li><p>These events may be fires with the regular CDI
                        mechanisms</p><pre class="programlisting">BeanManager beanManager;
...
beanManager.fireEvent(new BundleContainerEvents.BundleContainerInitialized(bundle.getBundleContext()));</pre><pre class="programlisting">Event&lt;Object&gt; event;
...
event.select(AbstractBundleEvent.class).fire(new BundleInstalled(bundle));</pre></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1219"/>3.13.1. CDI container lifecycle events</h3></div></div></div><p>CDI-OSGi provides a CDI event notification for bean bundle about bean bundle CDI
                container lifecycle events:</p><div class="itemizedlist"><ul><li><p>A <code class="code">BundleContainerInitialized</code> event is fired every time a
                            bean bundle CDI container is initialized</p></li><li><p>A <code class="code">BundleContainerShutdown</code> event is fired every time a bean
                            bundle CDI container is shutdown</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1237"/>3.13.2. Bundle lifecycle events</h3></div></div></div><p>CDI-OSGi provides a CDI event notification for bean bundle about bundle lifecycle events:</p><div class="itemizedlist"><ul><li><p>Such an event is fired every time the correspondent OSGi bundle event
                            is fired</p></li><li><p>All bundle lifecycle events may be listen using the
                                <code class="code">AbstractBundleEvent</code> event</p></li><li><p>Specific bundle lifecycle events are: <code class="code">BundleInstalled</code>,
                                <code class="code">BundleUninstalled</code>, <code class="code">BundleLazyActivation</code>,
                                <code class="code">BundleResolved</code>, <code class="code">BundleUnresolved</code>,
                                <code class="code">BundleUpdated</code>, <code class="code">BundleStarted</code>,
                                <code class="code">BundleStarting</code>, <code class="code">BundleStopped</code> and
                                <code class="code">BundleStopping</code></p></li></ul></div><p>It is possible to filter the listened source bundle by bundle symbolic name and
                (optional)
                version</p><pre class="programlisting">public void bindBundle(@Observes @BundleName("com.sample.gui") @BundleVersion("4.2.1") AbstractBundleEvent event) {
}
public void bindBundle(@Observes @BundleName("com.sample.gui") BundleInstalled event) {
}</pre><p>Only
                the events from the corresponding bundle are listened.</p><p>If a <code class="code">BundleVersion</code> annotation is provided without a
                    <code class="code">BundleName</code> annotation CDI-OSGi detects the problem and treats it as
                an error.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1297"/>3.13.3. Service lifecyle events</h3></div></div></div><p>CDI-OSGi provides a CDI event notification for bean bundle about service lifecycle events:</p><div class="itemizedlist"><ul><li><p>Such an event is fired every time the correspondent OSGi service event
                            is fired</p></li><li><p>All service lifecycle events may be listen using the
                                <code class="code">AbstractServiceEvent</code> event</p></li><li><p>Specific bundle lifecycle events are: <code class="code">ServiceArrival</code>,
                                <code class="code">ServiceDeparture</code> and <code class="code">ServiceChanged</code></p></li></ul></div><p>It is possible to filter the listened source service by specification and or OSGi
                LDAP properties and
                filter</p><pre class="programlisting">public void bindService(@Observes @Specification(MyService.class) AbstractServiceEvent event) {
}
public void bindService(@Observes @AnyQualifier ServiceArrival event) {
}
public void bindService(@Observes @Specification(MyService.class) @Filter("(&amp;(lang=EN)(country=US))") ServiceChanged event) {
}</pre><p>Only
                the corresponding service events are listened.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1328"/>3.13.4. Bean bundle required service dependency validation events</h3></div></div></div><p>CDI-OSGi provides a CDI event notification for bean bundle about bean bundle
                required service dependency validation:</p><div class="itemizedlist"><ul><li><p>A <code class="code">Valid</code> event is fired every time a bean bundle got all
                            its  required service dependency validated</p></li><li><p>A <code class="code">Invalid</code> event is fired every time a bean bundle got one
                            of its  required service dependency invalidated</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1346"/>3.13.5. Intra and inter bundles communication events</h3></div></div></div><p>CDI-OSGi provides a way to communicate within and between bean bundles:</p><div class="itemizedlist"><ul><li><p>A <code class="code">InterBundleEvent</code> is fired by a bean
                            bundle</p><pre class="programlisting">@Inject Event&lt;InterBundleEvent&gt; event;
MyMessage myMessage = new MyMessage();
event.fire(new InterBundleEvent(myMessage));</pre></li><li><p>A <code class="code">InterBundleEvent</code> may be listened by every active bean
                            bundle</p></li></ul></div><p>It is possible to filter the listened source message by message type and ignoring
                the events from the current
                bundle</p><pre class="programlisting">public void listenAllEventsFromOtherBundles(@Observes @Sent InterBundleEvent event) {
}
public void listenMyMessageEvents(@Observes @Specification(MyMessage.class) InterBundleEvent event) {
}
public void listenMyMessageEventsFromOtherBundles(@Observes @Sent @Specification(MyMessage.class) InterBundleEvent event) {
}</pre><p>Only
                the corresponding events are listened.</p></div></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="ch02.html"><strong>Prev</strong>Chapter 2. Organization of CDI-OSGi</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="ch04.html"><strong>Next</strong>Chapter 4. Weld-OSGi implementation</a></li></ul></body></html>